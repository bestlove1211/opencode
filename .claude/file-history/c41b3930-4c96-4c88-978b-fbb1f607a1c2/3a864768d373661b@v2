# Bancafi Debt Collection System - Updated Architecture

## System Overview (Updated)

The Bancafi Debt Collection system is a **upgradeable** decentralized platform for tokenizing, trading, and managing debt on Ethereum/EVM-compatible blockchains.

## Key Changes from Original Design

1. ‚ùå **Removed SPM Contract** - Security handled through standard smart contract patterns
2. ‚úÖ **Upgradeable Architecture** - Using OpenZeppelin UUPS proxy pattern
3. ‚úÖ **Enhanced Marketplace** - UI-optimized with comprehensive trading features
4. ‚úÖ **Slashing & Blacklisting** - Penalties for defaulted repayments
5. ‚úÖ **Institutional Onboarding** - Dedicated institutional investor features
6. ‚úÖ **Helper Contracts** - Utility libraries for common operations
7. ‚úÖ **Comprehensive Events** - All state changes emit events for UI tracking

## Smart Contract Architecture

### Core Contracts (Upgradeable)

#### 1. DebtToken (ERC-721, Upgradeable)
**File:** `contracts/DebtToken.sol`

**Purpose:** Tokenizes debt as upgradeable NFTs

**Key Features:**
- ERC-721 compliant debt tokens
- Rich metadata (debt type, amount, interest, schedule, collateral)
- Upgradeable via UUPS proxy pattern
- Role-based access control
- Pause mechanism for emergencies

**Events:**
```solidity
event DebtTokenMinted(uint256 indexed tokenId, address indexed debtor, uint256 principalAmount)
event DebtMetadataUpdated(uint256 indexed tokenId)
event RepaymentMade(uint256 indexed tokenId, uint256 amount, uint256 remaining)
event DebtDefaulted(uint256 indexed tokenId, uint256 missedPayments)
event CollateralLiquidated(uint256 indexed tokenId, uint256 amount)
```

#### 2. DebtMarketplace (Upgradeable)
**File:** `contracts/DebtMarketplace.sol`

**Purpose:** UI-optimized decentralized exchange for debt tokens

**Key Features:**

**Trading Modes:**
- **Direct Sale** - Fixed price listings
- **Auction** - English auction with bid increments
- **Offer System** - Buyers make offers on unlisted debts
- **Batch Trading** - Buy/sell multiple debts in one transaction

**Order Types:**
- Market orders (instant execution)
- Limit orders (price-based execution)
- Stop-loss orders (risk management)

**UI-Optimized Features:**
- Paginated listing queries
- Advanced filtering (by debt type, amount, rating, maturity)
- Sorting options (price, yield, risk rating)
- Watchlist functionality
- Trade history tracking
- Real-time price updates via events

**Default Handling:**
- Automatic slashing of seller reputation scores
- Blacklist mechanism for repeat defaulters
- Collateral seizure and liquidation
- Compensation pool for buyers

**Institutional Features:**
- Bulk purchase discounts
- OTC (over-the-counter) desk
- Priority access to premium debts
- Dedicated institutional verification tier
- Portfolio management tools

**Events:**
```solidity
event ListingCreated(uint256 indexed listingId, uint256 indexed tokenId, address seller, uint256 price)
event ListingCancelled(uint256 indexed listingId)
event ListingUpdated(uint256 indexed listingId, uint256 newPrice)
event TradExecuted(uint256 indexed listingId, address buyer, address seller, uint256 price)
event AuctionStarted(uint256 indexed auctionId, uint256 indexed tokenId, uint256 startingBid, uint256 endTime)
event BidPlaced(uint256 indexed auctionId, address bidder, uint256 amount)
event AuctionEnded(uint256 indexed auctionId, address winner, uint256 finalPrice)
event OfferMade(uint256 indexed offerId, uint256 indexed tokenId, address buyer, uint256 amount)
event OfferAccepted(uint256 indexed offerId)
event OfferRejected(uint256 indexed offerId)
event SellerSlashed(address indexed seller, uint256 indexed tokenId, uint256 penaltyAmount)
event UserBlacklisted(address indexed user, string reason)
event UserRemovedFromBlacklist(address indexed user)
event InstitutionalAccountCreated(address indexed institution, string name)
```

#### 3. ComplianceManager (Upgradeable)
**File:** `contracts/ComplianceManager.sol`

**Purpose:** KYC/AML enforcement with institutional onboarding

**Key Features:**

**KYC Levels:**
- Level 0: None (view-only access)
- Level 1: Basic (email/phone)
- Level 2: Identity (document verification)
- Level 3: Accredited Investor
- Level 4: Institutional (full due diligence)

**Institutional Onboarding:**
- Multi-step verification process
- Corporate document verification
- AML screening for entities
- Beneficial ownership disclosure
- Trading limit management
- Dedicated institutional dashboard

**Compliance Controls:**
- Geographic restrictions
- Transaction limits by KYC level
- Whitelist/blacklist management
- Sanctions screening integration
- Regulatory reporting hooks

**Events:**
```solidity
event KYCStatusUpdated(address indexed user, uint8 level, uint8 status)
event InstitutionOnboarded(address indexed institution, string entityName, string registrationNumber)
event InstitutionVerified(address indexed institution)
event InstitutionSuspended(address indexed institution, string reason)
event UserWhitelisted(address indexed user)
event UserBlacklisted(address indexed user)
event GeographicRestrictionAdded(string countryCode)
event TransactionLimitUpdated(uint8 kycLevel, uint256 newLimit)
event ComplianceViolation(address indexed user, string violationType)
```

#### 4. CollectionAutomator (Upgradeable)
**File:** `contracts/CollectionAutomator.sol`

**Purpose:** Automated debt collection and repayment with slashing

**Key Features:**

**Payment Collection:**
- Scheduled payment automation
- Interest calculation (simple & compound)
- Grace period management
- Late fee calculation
- Partial payment handling

**Default Handling:**
- Multi-tiered warning system
- Automatic default declaration
- Slashing penalties:
  - Reputation score reduction
  - Security deposit forfeiture
  - Trading privilege suspension
  - Blacklist addition for repeat offenders
- Collateral liquidation
- Loss distribution to affected parties

**Recovery Mechanisms:**
- Rehabilitation program for defaulters
- Partial recovery plans
- Debt restructuring options

**Events:**
```solidity
event PaymentScheduled(uint256 indexed tokenId, uint256 dueDate, uint256 amount)
event PaymentCollected(uint256 indexed tokenId, uint256 amount, uint256 timestamp)
event LatePayment(uint256 indexed tokenId, uint256 dayslate, uint256 lateFee)
event DefaultWarningIssued(uint256 indexed tokenId, uint8 warningLevel)
event DefaultDeclared(uint256 indexed tokenId, uint256 outstandingAmount)
event ReputationSlashed(address indexed debtor, uint256 oldScore, uint256 newScore)
event SecurityDepositSlashed(address indexed debtor, uint256 amount)
event CollateralLiquidationStarted(uint256 indexed tokenId, uint256 collateralValue)
event CollateralSold(uint256 indexed tokenId, uint256 saleAmount, address buyer)
event DebtorBlacklisted(address indexed debtor, uint256 indexed tokenId)
event RehabilitationStarted(address indexed debtor, uint256 planId)
```

#### 5. CrossChainBridge (Upgradeable)
**File:** `contracts/CrossChainBridge.sol`

**Purpose:** Multi-chain debt token transfers

**Key Features:**
- Lock-and-mint mechanism
- Support for Polygon, Arbitrum, Optimism
- Message verification
- Bridge security controls
- Fee management

**Events:**
```solidity
event TokensLocked(uint256 indexed tokenId, address indexed user, uint256 targetChain)
event TokensMinted(uint256 indexed tokenId, address indexed user, uint256 sourceChain)
event TokensBurned(uint256 indexed tokenId, address indexed user)
event TokensUnlocked(uint256 indexed tokenId, address indexed user)
event BridgeTransferInitiated(bytes32 indexed transferId, uint256 sourceChain, uint256 targetChain)
event BridgeTransferCompleted(bytes32 indexed transferId)
event BridgeTransferFailed(bytes32 indexed transferId, string reason)
```

### Helper Contracts & Libraries

#### 1. DebtCalculations Library
**File:** `contracts/libraries/DebtCalculations.sol`

**Purpose:** Mathematical operations for debt calculations

**Functions:**
```solidity
- calculateSimpleInterest()
- calculateCompoundInterest()
- calculateAmortization()
- calculatePresentValue()
- calculateYieldToMaturity()
- calculateDefaultPenalty()
- calculateLateFee()
```

#### 2. DataTypes Library
**File:** `contracts/libraries/DataTypes.sol`

**Purpose:** Common struct definitions

**Structs:**
```solidity
- DebtMetadata
- RepaymentSchedule
- Collateral
- Listing
- Auction
- Offer
- KYCData
- InstitutionalProfile
- PaymentRecord
- DefaultRecord
```

#### 3. Errors Library
**File:** `contracts/libraries/Errors.sol`

**Purpose:** Custom error definitions for gas efficiency

#### 4. Events Library
**File:** `contracts/libraries/Events.sol`

**Purpose:** Centralized event definitions

#### 5. PriceOracle Helper
**File:** `contracts/helpers/PriceOracle.sol`

**Purpose:** Price feeds for debt valuation and collateral pricing

**Features:**
- Chainlink price feed integration
- TWAP (Time-Weighted Average Price) calculation
- Price deviation monitoring

#### 6. ReputationManager Helper
**File:** `contracts/helpers/ReputationManager.sol`

**Purpose:** On-chain reputation scoring

**Features:**
- Payment history tracking
- Reputation score calculation
- Slashing logic
- Reputation recovery mechanisms

#### 7. NotificationEmitter Helper
**File:** `contracts/helpers/NotificationEmitter.sol`

**Purpose:** Emit standardized events for off-chain indexing

**Features:**
- User action notifications
- System alerts
- Payment reminders
- Compliance notifications

## UI Integration Strategy

### Frontend Requirements

**Real-time Data:**
- Listen to marketplace events via WebSocket
- Update listings without page refresh
- Show live auction bids
- Display notification badges

**Key UI Views:**

1. **Marketplace Dashboard**
   - Grid/list view of available debts
   - Advanced filters panel
   - Sort dropdown
   - Search functionality
   - Quick stats (total volume, active listings)

2. **Debt Detail Page**
   - Full debt metadata
   - Repayment schedule visualization
   - Price history chart
   - Seller reputation
   - Buy/offer buttons

3. **Trading Interface**
   - Order book view
   - Recent trades feed
   - User's active orders
   - Portfolio value tracker

4. **Institutional Portal**
   - Bulk trading interface
   - Portfolio analytics
   - OTC desk
   - Compliance dashboard

5. **Collection Dashboard**
   - Owned debt tokens
   - Payment schedules
   - Collection status
   - Default alerts

## Deployment Strategy

### Upgradeable Proxy Pattern (UUPS)

```
User ‚Üí Proxy Contract ‚Üí Implementation Contract
```

**Benefits:**
- Fix bugs without redeployment
- Add features over time
- Preserve contract addresses
- Maintain state across upgrades

**Deployment Steps:**
1. Deploy implementation contracts
2. Deploy proxy contracts pointing to implementations
3. Initialize proxies with setup data
4. Transfer admin rights to multi-sig wallet
5. Verify contracts on Etherscan

### Multi-sig Governance

- 3-of-5 multi-sig for upgrades
- Time-lock for critical changes
- Emergency pause capability
- Community governance roadmap

## Testing Strategy

1. **Unit Tests** - Test each function individually
2. **Integration Tests** - Test contract interactions
3. **Upgrade Tests** - Test upgrade paths
4. **Gas Optimization Tests** - Benchmark gas usage
5. **Security Tests** - Edge cases and attack vectors
6. **UI Integration Tests** - Event emission validation

## Security Considerations

1. **Reentrancy Protection** - OpenZeppelin ReentrancyGuard
2. **Access Control** - Role-based permissions
3. **Pause Mechanism** - Emergency shutdown
4. **Rate Limiting** - Prevent spam attacks
5. **Input Validation** - Strict parameter checks
6. **Oracle Manipulation Protection** - TWAP and deviation checks
7. **Front-running Protection** - Commit-reveal for sensitive operations

## Gas Optimization

1. Pack struct variables efficiently
2. Use custom errors instead of strings
3. Cache storage variables in memory
4. Use immutable for constants
5. Batch operations where possible
6. Optimize loop iterations

## Next Steps

1. ‚úÖ Updated architecture
2. üìù Implement helper libraries
3. üìù Implement core upgradeable contracts
4. üìù Write comprehensive tests
5. üìù Create deployment scripts
6. üìù Security audit preparation
7. üìù Frontend integration guide
