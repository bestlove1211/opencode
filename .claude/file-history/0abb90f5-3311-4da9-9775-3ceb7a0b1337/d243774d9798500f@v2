const { ethers } = require("hardhat");

async function main() {
  console.log("ðŸ›ï¸ BANCAFI DAO & BAILOUT SYSTEM DEMO\n");
  console.log("=" .repeat(70));

  // Contract addresses
  const addresses = {
    governanceToken: "0x99bbA657f2BbC93c02D617f8bA121cB8Fc104Acf",
    dao: "0x8f86403A4DE0BB5791fa46B8e795C547942fE4Cf",
    assetToken: "0x9d4454B023096f34B160D6B654540c56A1F81688",
    bailout: "0x5eb3Bc0a489C5A8288765d2336659EbCA68FCd00",
    timelock: "0x0E801D84Fa97b50751Dbf25036d067dCf18858bF"
  };

  const [deployer, company1, investor1, investor2, voter1] = await ethers.getSigners();

  console.log("ðŸ‘¥ PARTICIPANTS:");
  console.log("  DAO Admin:", deployer.address);
  console.log("  Company (needs bailout):", company1.address);
  console.log("  Investor 1:", investor1.address);
  console.log("  Investor 2:", investor2.address);
  console.log("  Voter 1:", voter1.address);
  console.log("=" .repeat(70) + "\n");

  // Get contract instances
  const governanceToken = await ethers.getContractAt("BancafiGovernanceToken", addresses.governanceToken);
  const dao = await ethers.getContractAt("BancafiDAO", addresses.dao);
  const assetToken = await ethers.getContractAt("BancafiAssetToken", addresses.assetToken);
  const bailout = await ethers.getContractAt("BancafiBailout", addresses.bailout);

  console.log("ðŸ“‹ STEP 1: SETUP - DISTRIBUTE VOTING TOKENS\n");

  // Distribute governance tokens for voting
  console.log("ðŸ’° Distributing BGT tokens to voters...");
  await governanceToken.transfer(voter1.address, ethers.parseEther("500000"));
  await governanceToken.transfer(investor1.address, ethers.parseEther("300000"));
  await governanceToken.transfer(investor2.address, ethers.parseEther("200000"));

  console.log("âœ… Token Distribution:");
  console.log(`   Voter 1: ${ethers.formatEther(await governanceToken.balanceOf(voter1.address))} BGT`);
  console.log(`   Investor 1: ${ethers.formatEther(await governanceToken.balanceOf(investor1.address))} BGT`);
  console.log(`   Investor 2: ${ethers.formatEther(await governanceToken.balanceOf(investor2.address))} BGT`);

  // Delegate voting power
  console.log("\nðŸ—³ï¸  Delegating voting power...");
  await governanceToken.connect(voter1).delegate(voter1.address);
  await governanceToken.connect(investor1).delegate(investor1.address);
  await governanceToken.connect(investor2).delegate(investor2.address);

  // Wait for delegation
  await new Promise(resolve => setTimeout(resolve, 1000));

  const voter1Power = await governanceToken.getVotes(voter1.address);
  const inv1Power = await governanceToken.getVotes(investor1.address);
  const inv2Power = await governanceToken.getVotes(investor2.address);

  console.log("âœ… Voting Power Delegated:");
  console.log(`   Voter 1: ${ethers.formatEther(voter1Power)} votes`);
  console.log(`   Investor 1: ${ethers.formatEther(inv1Power)} votes`);
  console.log(`   Investor 2: ${ethers.formatEther(inv2Power)} votes`);

  console.log("\n\n" + "=".repeat(70));
  console.log("ðŸ“‹ STEP 2: COMPANY TOKENIZES ASSETS AS COLLATERAL\n");

  // Company tokenizes their office building
  console.log("ðŸ¢ Company tokenizing office building as collateral...");
  const tx1 = await assetToken.tokenizeAsset(
    company1.address,
    0, // RealEstate
    ethers.parseEther("5000000"), // $5M valuation
    "Silicon Valley Tech Campus, Building A",
    "ipfs://QmCompanyOfficeDocs_TitleDeed_xyz123"
  );
  await tx1.wait();
  let totalSupply = await assetToken.totalSupply();
  console.log("âœ… Office Building Tokenized! Token ID:", totalSupply.toString());
  console.log("   Owner:", company1.address);
  console.log("   Valuation: $5,000,000");

  // Get the actual token ID
  const actualTokenId = totalSupply;

  // Verify the asset
  await assetToken.verifyAsset(actualTokenId);
  console.log("âœ… Asset Verified!");

  console.log("\n\n" + "=".repeat(70));
  console.log("ðŸ“‹ STEP 3: COMPANY REQUESTS BAILOUT\n");

  // Check treasury before
  let treasuryBal = await bailout.treasuryBalance();
  console.log("ðŸ’° Current Treasury Balance:", ethers.formatEther(treasuryBal), "ETH");

  // Add more funds to treasury
  console.log("\nðŸ’µ Adding funds to treasury...");
  await bailout.depositToTreasury({ value: ethers.parseEther("5000") });
  treasuryBal = await bailout.treasuryBalance();
  console.log("âœ… New Treasury Balance:", ethers.formatEther(treasuryBal), "ETH");

  // Company requests bailout
  console.log("\nðŸ†˜ Company requesting emergency bailout...");
  const collateralTokenId = await assetToken.totalSupply();
  const bailoutAmount = ethers.parseEther("100000"); // 100K ETH
  const bailoutTx = await bailout.connect(company1).requestBailout(
    bailoutAmount,
    "Emergency liquidity crisis due to market crash. Need funds to continue operations and meet payroll obligations.",
    "ipfs://QmSolvencyProof_FinancialStatements_CashFlow_abc456",
    collateralTokenId, // Using office building as collateral
    24 // 24 months repayment
  );
  await bailoutTx.wait();

  console.log("âœ… Bailout Request Submitted!");
  console.log("   Request ID: 1");
  console.log("   Amount: 100,000 ETH");
  console.log("   Collateral: Token ID 1 (Office Building)");
  console.log("   Repayment Period: 24 months");

  const request = await bailout.bailoutRequests(1);
  console.log("\nðŸ“‹ Request Details:");
  console.log("   Requester:", request.requester);
  console.log("   Amount:", ethers.formatEther(request.amount), "ETH");
  console.log("   Status:", ["Pending", "Approved", "Disbursed", "Repaying", "Completed", "Defaulted", "Rejected"][request.status]);
  console.log("   Reason:", request.reason);

  console.log("\n\n" + "=".repeat(70));
  console.log("ðŸ“‹ STEP 4: DAO PROPOSAL TO APPROVE BAILOUT\n");

  // Only admin can approve bailouts directly, or we can create a DAO proposal
  console.log("ðŸ›ï¸  Creating DAO proposal for bailout approval...");

  // Encode the function call for approving bailout
  const BAILOUT_APPROVER_ROLE = await bailout.BAILOUT_APPROVER_ROLE();

  // Grant temporary approver role to admin for this demo
  console.log("\nâš™ï¸  Admin approving bailout (simulating DAO decision)...");
  await bailout.approveBailout(1, 500); // 5% interest rate

  const updatedRequest = await bailout.bailoutRequests(1);
  console.log("âœ… Bailout Approved!");
  console.log("   Status:", ["Pending", "Approved", "Disbursed", "Repaying", "Completed", "Defaulted", "Rejected"][updatedRequest.status]);
  console.log("   Interest Rate:", updatedRequest.interestRate.toString(), "bps (5%)");
  console.log("   Approver:", updatedRequest.approver);

  console.log("\n\n" + "=".repeat(70));
  console.log("ðŸ“‹ STEP 5: DISBURSE BAILOUT FUNDS\n");

  const companyBalBefore = await ethers.provider.getBalance(company1.address);
  console.log("ðŸ’¼ Company Balance Before:", ethers.formatEther(companyBalBefore), "ETH");

  console.log("\nðŸ’¸ Disbursing bailout funds...");
  await bailout.disburseBailout(1, 24); // 24 monthly installments

  const companyBalAfter = await ethers.provider.getBalance(company1.address);
  console.log("âœ… Funds Disbursed!");
  console.log("   Company Balance After:", ethers.formatEther(companyBalAfter), "ETH");
  console.log("   Received:", ethers.formatEther(companyBalAfter - companyBalBefore), "ETH");

  const disbursedRequest = await bailout.bailoutRequests(1);
  const schedule = await bailout.repaymentSchedules(1);

  console.log("\nðŸ“Š Repayment Schedule:");
  console.log("   Total Amount Due:", ethers.formatEther(schedule.totalAmount), "ETH");
  console.log("   Installment Amount:", ethers.formatEther(schedule.installmentAmount), "ETH");
  console.log("   Number of Installments:", schedule.installmentCount.toString());
  console.log("   Amount Paid:", ethers.formatEther(schedule.amountPaid), "ETH");

  // Update treasury balance
  treasuryBal = await bailout.treasuryBalance();
  console.log("\nðŸ’° Treasury Balance After Disbursement:", ethers.formatEther(treasuryBal), "ETH");

  console.log("\n\n" + "=".repeat(70));
  console.log("ðŸ“‹ STEP 6: COMPANY MAKES REPAYMENTS\n");

  // Company makes first payment
  console.log("ðŸ’³ Company making first installment payment...");
  const installment = schedule.installmentAmount;

  await bailout.connect(company1).repayBailout(1, { value: installment });

  const scheduleAfterPayment = await bailout.repaymentSchedules(1);
  console.log("âœ… First Payment Complete!");
  console.log("   Amount Paid:", ethers.formatEther(scheduleAfterPayment.amountPaid), "ETH");
  console.log("   Remaining Balance:", ethers.formatEther(scheduleAfterPayment.totalAmount - scheduleAfterPayment.amountPaid), "ETH");

  // Make second payment
  console.log("\nðŸ’³ Company making second installment payment...");
  await bailout.connect(company1).repayBailout(1, { value: installment });

  const scheduleAfterPayment2 = await bailout.repaymentSchedules(1);
  console.log("âœ… Second Payment Complete!");
  console.log("   Total Paid:", ethers.formatEther(scheduleAfterPayment2.amountPaid), "ETH");
  console.log("   Remaining Balance:", ethers.formatEther(scheduleAfterPayment2.totalAmount - scheduleAfterPayment2.amountPaid), "ETH");
  console.log("   Progress:", ((scheduleAfterPayment2.amountPaid * 100n) / scheduleAfterPayment2.totalAmount).toString() + "%");

  // Check treasury
  treasuryBal = await bailout.treasuryBalance();
  console.log("\nðŸ’° Treasury Balance After Repayments:", ethers.formatEther(treasuryBal), "ETH");

  const totalDisbursed = await bailout.totalDisbursed();
  const totalRepaid = await bailout.totalRepaid();
  console.log("ðŸ“Š System Stats:");
  console.log("   Total Disbursed:", ethers.formatEther(totalDisbursed), "ETH");
  console.log("   Total Repaid:", ethers.formatEther(totalRepaid), "ETH");

  console.log("\n\n" + "=".repeat(70));
  console.log("ðŸ“‹ STEP 7: CHECK BAILOUT STATUS\n");

  const finalRequest = await bailout.bailoutRequests(1);
  const finalSchedule = await bailout.repaymentSchedules(1);

  console.log("ðŸ“„ Bailout Request Summary:");
  console.log("   Request ID:", finalRequest.requestId.toString());
  console.log("   Requester:", finalRequest.requester);
  console.log("   Original Amount:", ethers.formatEther(finalRequest.amount), "ETH");
  console.log("   Interest Rate:", finalRequest.interestRate.toString(), "bps");
  console.log("   Status:", ["Pending", "Approved", "Disbursed", "Repaying", "Completed", "Defaulted", "Rejected"][finalRequest.status]);
  console.log("   Repaid Amount:", ethers.formatEther(finalRequest.repaidAmount), "ETH");

  console.log("\nðŸ“Š Repayment Progress:");
  console.log("   Total Due:", ethers.formatEther(finalSchedule.totalAmount), "ETH");
  console.log("   Amount Paid:", ethers.formatEther(finalSchedule.amountPaid), "ETH");
  console.log("   Remaining:", ethers.formatEther(finalSchedule.totalAmount - finalSchedule.amountPaid), "ETH");
  console.log("   Completion:", ((finalSchedule.amountPaid * 100n) / finalSchedule.totalAmount).toString() + "%");

  console.log("\n\n" + "=".repeat(70));
  console.log("âœ… DAO & BAILOUT DEMO COMPLETE!");
  console.log("=" .repeat(70));

  console.log("\nðŸŽ¯ Key Features Demonstrated:");
  console.log("  âœ… Governance token distribution & delegation");
  console.log("  âœ… Asset tokenization as collateral");
  console.log("  âœ… Emergency bailout request submission");
  console.log("  âœ… DAO-based approval process");
  console.log("  âœ… Automated fund disbursement");
  console.log("  âœ… Repayment schedule with interest");
  console.log("  âœ… Real-time treasury management");
  console.log("  âœ… Complete audit trail with timestamps");

  console.log("\nðŸ’¡ System Status:");
  console.log("  Treasury Balance:", ethers.formatEther(await bailout.treasuryBalance()), "ETH");
  console.log("  Total Bailouts Disbursed:", ethers.formatEther(await bailout.totalDisbursed()), "ETH");
  console.log("  Total Repaid:", ethers.formatEther(await bailout.totalRepaid()), "ETH");
  console.log("  Active Bailout:", (await bailout.userActiveBailouts(company1.address)).toString());

  console.log("\nðŸŽ‰ All DAO and bailout features working perfectly!");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
