const { ethers, upgrades } = require("hardhat");

async function main() {
  console.log("ðŸš€ Starting Bancafi deployment...\n");

  const [deployer] = await ethers.getSigners();
  console.log("Deploying with account:", deployer.address);
  console.log("Account balance:", ethers.formatEther(await ethers.provider.getBalance(deployer.address)), "ETH\n");

  // ========== 1. Deploy Governance Token ==========
  console.log("ðŸ“ Deploying Governance Token...");
  const GovernanceToken = await ethers.getContractFactory("BancafiGovernanceToken");

  const tokenName = "Bancafi Governance Token";
  const tokenSymbol = "BGT";
  const maxSupply = ethers.parseEther("1000000000"); // 1 billion tokens
  const initialSupply = ethers.parseEther("100000000"); // 100 million initial

  const governanceToken = await upgrades.deployProxy(
    GovernanceToken,
    [tokenName, tokenSymbol, maxSupply, initialSupply, deployer.address],
    { initializer: "initialize", kind: "uups" }
  );
  await governanceToken.waitForDeployment();
  const tokenAddress = await governanceToken.getAddress();
  console.log("âœ… Governance Token deployed to:", tokenAddress);
  console.log("   Total Supply:", ethers.formatEther(await governanceToken.totalSupply()), tokenSymbol, "\n");

  // ========== 2. Deploy Timelock Controller ==========
  console.log("â° Deploying Timelock Controller...");
  const minDelay = 2 * 24 * 60 * 60; // 2 days
  const proposers = [deployer.address]; // Will add DAO later
  const executors = [deployer.address]; // Will add DAO later
  const admin = deployer.address;

  const TimelockController = await ethers.getContractFactory("TimelockController");
  const timelock = await TimelockController.deploy(
    minDelay,
    proposers,
    executors,
    admin
  );
  await timelock.waitForDeployment();
  const timelockAddress = await timelock.getAddress();
  console.log("âœ… Timelock deployed to:", timelockAddress);
  console.log("   Min Delay:", minDelay / (24 * 60 * 60), "days\n");

  // ========== 3. Deploy DAO ==========
  console.log("ðŸ›ï¸  Deploying DAO Governor...");
  const DAO = await ethers.getContractFactory("BancafiDAO");

  const votingDelay = 1; // 1 block
  const votingPeriod = 50400; // ~1 week (assuming 12s blocks)
  const proposalThreshold = ethers.parseEther("1000"); // 1000 tokens to propose
  const quorumPercentage = 4; // 4% quorum

  const dao = await upgrades.deployProxy(
    DAO,
    [tokenAddress, timelockAddress, votingDelay, votingPeriod, proposalThreshold, quorumPercentage],
    { initializer: "initialize", kind: "uups" }
  );
  await governanceToken.waitForDeployment();
  const daoAddress = await dao.getAddress();
  console.log("âœ… DAO deployed to:", daoAddress);
  console.log("   Voting Period:", votingPeriod, "blocks");
  console.log("   Quorum:", quorumPercentage, "%\n");

  // ========== 4. Deploy Asset Tokenization Contract ==========
  console.log("ðŸ  Deploying Asset Token Contract...");
  const AssetToken = await ethers.getContractFactory("BancafiAssetToken");

  const assetToken = await upgrades.deployProxy(
    AssetToken,
    ["Bancafi Real World Assets", "BRWA"],
    { initializer: "initialize", kind: "uups" }
  );
  await assetToken.waitForDeployment();
  const assetTokenAddress = await assetToken.getAddress();
  console.log("âœ… Asset Token deployed to:", assetTokenAddress, "\n");

  // ========== 5. Deploy Bailout Contract ==========
  console.log("ðŸ’° Deploying Bailout Contract...");
  const Bailout = await ethers.getContractFactory("BancafiBailout");

  const maxBailoutAmount = ethers.parseEther("10000000"); // 10M ETH max
  const minCollateralRatio = 15000; // 150% (in basis points)

  const bailout = await upgrades.deployProxy(
    Bailout,
    [maxBailoutAmount, minCollateralRatio],
    { initializer: "initialize", kind: "uups" }
  );
  await bailout.waitForDeployment();
  const bailoutAddress = await bailout.getAddress();
  console.log("âœ… Bailout deployed to:", bailoutAddress);
  console.log("   Max Bailout:", ethers.formatEther(maxBailoutAmount), "ETH");
  console.log("   Min Collateral Ratio:", minCollateralRatio / 100, "%\n");

  // ========== 6. Configure Roles and Permissions ==========
  console.log("ðŸ” Configuring roles and permissions...");

  // Grant DAO proposer role to DAO contract on timelock
  const PROPOSER_ROLE = await timelock.PROPOSER_ROLE();
  const EXECUTOR_ROLE = await timelock.EXECUTOR_ROLE();
  const CANCELLER_ROLE = await timelock.CANCELLER_ROLE();

  await timelock.grantRole(PROPOSER_ROLE, daoAddress);
  await timelock.grantRole(EXECUTOR_ROLE, daoAddress);
  console.log("âœ… DAO granted proposer/executor roles on Timelock");

  // Grant bailout approver role to DAO
  const BAILOUT_APPROVER_ROLE = await bailout.BAILOUT_APPROVER_ROLE();
  await bailout.grantRole(BAILOUT_APPROVER_ROLE, daoAddress);
  console.log("âœ… DAO granted bailout approver role");

  // Self-delegate governance tokens for voting
  await governanceToken.delegate(deployer.address);
  console.log("âœ… Deployer self-delegated tokens for voting\n");

  // ========== 7. Deposit Initial Treasury Funds ==========
  console.log("ðŸ’µ Depositing initial treasury funds...");
  const initialTreasuryFunds = ethers.parseEther("1000"); // 1000 ETH
  const depositTx = await bailout.depositToTreasury({ value: initialTreasuryFunds });
  await depositTx.wait();
  console.log("âœ… Deposited", ethers.formatEther(initialTreasuryFunds), "ETH to treasury\n");

  // ========== 8. Summary ==========
  console.log("=" .repeat(60));
  console.log("ðŸŽ‰ DEPLOYMENT COMPLETE!\n");
  console.log("Contract Addresses:");
  console.log("=" .repeat(60));
  console.log("Governance Token:  ", tokenAddress);
  console.log("Timelock:          ", timelockAddress);
  console.log("DAO Governor:      ", daoAddress);
  console.log("Asset Token (NFT): ", assetTokenAddress);
  console.log("Bailout System:    ", bailoutAddress);
  console.log("=" .repeat(60));

  // Save to JSON
  const deployment = {
    network: (await ethers.provider.getNetwork()).name,
    chainId: (await ethers.provider.getNetwork()).chainId,
    deployer: deployer.address,
    timestamp: new Date().toISOString(),
    contracts: {
      governanceToken: tokenAddress,
      timelock: timelockAddress,
      dao: daoAddress,
      assetToken: assetTokenAddress,
      bailout: bailoutAddress
    }
  };

  const fs = require("fs");
  fs.writeFileSync(
    "deployment.json",
    JSON.stringify(deployment, null, 2)
  );
  console.log("\nðŸ“„ Deployment info saved to deployment.json\n");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
