# Bancafi Credit Deployment Guide

## Overview

This guide covers the complete deployment process for the Bancafi Credit platform, including contract deployment, verification, configuration, and upgrade procedures.

## Prerequisites

### Required Tools

```bash
# Install dependencies
npm install

# Install Hardhat
npm install --save-dev hardhat @nomiclabs/hardhat-ethers @nomiclabs/hardhat-etherscan

# OpenZeppelin
npm install @openzeppelin/contracts-upgradeable @openzeppelin/hardhat-upgrades

# Chainlink
npm install @chainlink/contracts
```

### Environment Setup

Create `.env` file:

```env
# Network RPC URLs
MAINNET_RPC_URL=https://mainnet.infura.io/v3/YOUR_KEY
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_KEY
POLYGON_RPC_URL=https://polygon-rpc.com
ARBITRUM_RPC_URL=https://arb1.arbitrum.io/rpc

# Private Keys (NEVER commit these!)
DEPLOYER_PRIVATE_KEY=your_private_key_here

# Etherscan API Keys
ETHERSCAN_API_KEY=your_etherscan_key
POLYGONSCAN_API_KEY=your_polygonscan_key
ARBISCAN_API_KEY=your_arbiscan_key

# Configuration
PLATFORM_FEE=50  # 0.5%
MIN_LOAN_DURATION=604800  # 7 days
MAX_LOAN_DURATION=31536000  # 365 days
```

## Deployment Process

### Step 1: Compile Contracts

```bash
npx hardhat compile
```

Ensure no compilation errors and all contracts use Solidity 0.8.25.

### Step 2: Run Tests

```bash
npx hardhat test
```

All tests must pass before deployment.

### Step 3: Deploy to Testnet

Deploy to Sepolia testnet first for testing:

```bash
npx hardhat run scripts/deploy-all.ts --network sepolia
```

**Expected Output:**
```
ðŸš€ Starting Bancafi Credit Platform Deployment...

Deployer address: 0x...
Network: sepolia
Chain ID: 11155111
Balance: 1.5 ETH

ðŸ“Š Deploying BancafiPriceOracle...
âœ… Price Oracle deployed at: 0x...

ðŸ” Deploying BancafiCompliance...
âœ… Compliance deployed at: 0x...

ðŸ’¯ Deploying CreditScore...
âœ… Credit Score deployed at: 0x...

...

ðŸŽ‰ DEPLOYMENT COMPLETE!
```

### Step 4: Verify Contracts

Verify all contracts on block explorer:

```bash
npx hardhat run scripts/verify-contracts.ts --network sepolia
```

### Step 5: Configure System

Run configuration script:

```bash
npx hardhat run scripts/configure-system.ts --network sepolia
```

This will:
- Configure price oracle with Chainlink feeds
- Set up multi-asset collateral parameters
- Add sanctioned countries to compliance
- Configure lending platform limits
- Set up insurance pool parameters
- Configure private credit line tiers
- Grant necessary roles

### Step 6: Test on Testnet

Thoroughly test all features:

1. **User Registration**
   - Connect wallet
   - Register and verify KYC
   - Test compliance checks

2. **Lending Operations**
   - Create borrow requests
   - Accept lending offers
   - Repay loans
   - Test liquidations

3. **Collateral Management**
   - Lock single-asset collateral
   - Create multi-asset baskets
   - Test health checks
   - Trigger liquidation

4. **Advanced Features**
   - Apply for private credit lines
   - List debts on BBM marketplace
   - Create portfolio bundles
   - Purchase insurance policies

5. **Institutional Features**
   - Submit institution application
   - Configure multi-sig
   - Execute batch transactions

### Step 7: Deploy to Mainnet

Once testnet testing is complete:

```bash
# Deploy to mainnet
npx hardhat run scripts/deploy-all.ts --network mainnet

# Verify contracts
npx hardhat run scripts/verify-contracts.ts --network mainnet

# Configure system
npx hardhat run scripts/configure-system.ts --network mainnet
```

âš ï¸ **IMPORTANT**: Double-check all addresses and configuration before mainnet deployment!

## Deployment Architecture

### Contract Deployment Order

```mermaid
graph TD
    A[1. Price Oracle] --> B[2. Compliance]
    A --> C[3. Credit Score]
    A --> D[4. Collateral Manager]
    A --> E[5. Multi-Asset Collateral]
    C --> F[6. Bancafi Lending]
    D --> F
    F --> G[7. Debt Collection]
    C --> G
    C --> H[8. Private Credit Line]
    D --> H
    B --> I[9. Institutional Onboarding]
    G --> J[10. Block Market]
    G --> K[11. Portfolio Manager]
    A --> L[12. Insurance Pool]
    M[13. Wallet Integration]
```

### Dependencies

- **Price Oracle**: No dependencies (deployed first)
- **Compliance**: No dependencies
- **Credit Score**: No dependencies
- **Collateral Manager**: No dependencies
- **Multi-Asset Collateral**: Requires Price Oracle
- **Bancafi Lending**: Requires Credit Score, Collateral Manager
- **Debt Collection**: Requires Lending, Credit Score
- **Private Credit Line**: Requires Credit Score, Collateral Manager
- **Institutional Onboarding**: Requires Compliance
- **Block Market**: Requires Debt Collection
- **Portfolio Manager**: Requires Debt Collection
- **Insurance**: Requires Price Oracle
- **Wallet Integration**: No dependencies

## Network Configurations

### Ethereum Mainnet

```javascript
{
  chainId: 1,
  rpcUrl: process.env.MAINNET_RPC_URL,
  explorerUrl: 'https://etherscan.io',
  gasPrice: 'auto',
  confirmations: 2,
}
```

**Chainlink Feeds:**
- ETH/USD: `0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419`
- BTC/USD: `0xF4030086522a5bEEa4988F8cA5B36dbC97BeE88c`
- USDC/USD: `0x8fFfFfd4AfB6115b954Bd326cbe7B4BA576818f6`

### Sepolia Testnet

```javascript
{
  chainId: 11155111,
  rpcUrl: process.env.SEPOLIA_RPC_URL,
  explorerUrl: 'https://sepolia.etherscan.io',
  gasPrice: 'auto',
  confirmations: 1,
}
```

**Chainlink Feeds:**
- ETH/USD: `0x694AA1769357215DE4FAC081bf1f309aDC325306`

### Polygon

```javascript
{
  chainId: 137,
  rpcUrl: process.env.POLYGON_RPC_URL,
  explorerUrl: 'https://polygonscan.com',
  gasPrice: 'auto',
  confirmations: 3,
}
```

## Contract Upgrades

All contracts use UUPS proxy pattern for upgradeability.

### Upgrade Process

1. **Prepare New Implementation**

```solidity
// Update contract code
contract BancafiLendingV2 is BancafiLending {
    // Add new features
    // NEVER modify existing storage layout!
}
```

2. **Test Upgrade Locally**

```bash
npx hardhat test test/upgrades/lending-upgrade.test.ts
```

3. **Validate Upgrade**

```bash
# Set environment variables
export CONTRACT_NAME=BancafiLending
export PROXY_ADDRESS=0x...

# Run upgrade script
npx hardhat run scripts/upgrade-contract.ts --network sepolia
```

**Expected Output:**
```
ðŸ”„ Starting contract upgrade...

Contract: BancafiLending
Proxy Address: 0x...
Upgrader: 0x...

Loading BancafiLending factory...
Validating upgrade compatibility...
âœ… Upgrade validation passed

Upgrading contract...

âœ… UPGRADE SUCCESSFUL!
Proxy Address: 0x...
New Implementation: 0x...
```

4. **Verify New Implementation**

```bash
npx hardhat verify --network sepolia NEW_IMPLEMENTATION_ADDRESS
```

### Storage Layout Rules

âš ï¸ **CRITICAL**: Follow these rules to avoid storage collisions:

```solidity
// âœ… Good: Adding new variables at the end
contract V1 {
    uint256 public value1;
    uint256 public value2;
}

contract V2 is V1 {
    uint256 public value3;  // âœ… New variable at end
    uint256 public value4;  // âœ… OK
}

// âŒ Bad: Modifying existing storage
contract V2Bad is V1 {
    uint256 public value1;  // âŒ Already exists
    address public value2;  // âŒ Type change!
    // Missing value2       // âŒ Removed variable
}
```

### Gap Pattern

All contracts include storage gap for future upgrades:

```solidity
/**
 * @dev Reserved storage space for future versions
 */
uint256[50] private __gap;
```

When adding new variables, reduce gap size:

```solidity
// V1
uint256[50] private __gap;

// V2 - Added 2 new variables
uint256 public newVar1;
uint256 public newVar2;
uint256[48] private __gap;  // Reduced by 2
```

## Post-Deployment Checklist

### Immediate Actions

- [ ] Verify all contracts on block explorer
- [ ] Save deployment addresses securely
- [ ] Update frontend environment variables
- [ ] Test basic functionality (register, lend, borrow)
- [ ] Fund insurance pool with initial capital
- [ ] Add initial KYC verifiers
- [ ] Add compliance officers
- [ ] Configure emergency contacts

### Security Setup

- [ ] Transfer ownership to multi-sig wallet
- [ ] Set up Gnosis Safe with 3/5 signers
- [ ] Enable timelock for critical operations
- [ ] Set up monitoring and alerts
- [ ] Configure pause guardians
- [ ] Set up oracle monitoring
- [ ] Enable rate limiting where needed
- [ ] Test emergency pause functionality

### Operational Setup

- [ ] Deploy subgraph for event indexing
- [ ] Set up backend API
- [ ] Configure IPFS for KYC document storage
- [ ] Set up email notifications
- [ ] Configure Telegram/Discord alerts
- [ ] Set up analytics dashboard
- [ ] Create admin panel
- [ ] Set up customer support system

### Documentation

- [ ] Update API documentation
- [ ] Create user guides
- [ ] Write integration tutorials
- [ ] Document admin procedures
- [ ] Create emergency runbook
- [ ] Document upgrade procedures
- [ ] Write audit response plan

### Marketing & Launch

- [ ] Announce on social media
- [ ] Publish blog post
- [ ] Submit to DeFi aggregators
- [ ] List on token tracking sites
- [ ] Reach out to institutional partners
- [ ] Schedule AMAs
- [ ] Create tutorial videos

## Monitoring & Maintenance

### Health Checks

Run daily health checks:

```bash
npx hardhat run scripts/health-check.ts --network mainnet
```

Checks:
- Contract balances
- Oracle price freshness
- Pending liquidations
- Insurance pool solvency
- Compliance status
- System pause status

### Event Monitoring

Monitor critical events:

```javascript
// Loan defaults
lending.on('LoanDefaulted', (loanId, borrower, amount) => {
  alert(`Loan ${loanId} defaulted: ${amount}`);
});

// Liquidations
collateral.on('BasketLiquidated', (basketId, liquidator, value) => {
  log(`Basket ${basketId} liquidated for $${value}`);
});

// Large transactions
lending.on('LoanCreated', (loanId, amount) => {
  if (amount > THRESHOLD) {
    alert(`Large loan created: $${amount}`);
  }
});
```

### Gas Optimization

Monitor gas usage:

```bash
npx hardhat test --gas-reporter
```

Optimize high-gas functions if needed.

### Oracle Monitoring

Check oracle health:

```javascript
async function checkOracles() {
  const oracle = await ethers.getContractAt('BancafiPriceOracle', address);

  const assets = await oracle.getSupportedAssets();

  for (const asset of assets) {
    const price = await oracle.getLatestPrice(asset);
    const timestamp = await oracle.getLastUpdateTimestamp(asset);
    const age = Date.now() / 1000 - timestamp;

    if (age > 3600) {
      alert(`Oracle for ${asset} is stale (${age}s old)`);
    }
  }
}
```

## Emergency Procedures

### Contract Pause

If critical issue detected:

```bash
npx hardhat run scripts/emergency-pause.ts --network mainnet
```

This will pause all contracts immediately.

### Upgrade Rollback

If upgrade causes issues:

```bash
# Get previous implementation from upgrade history
export PREVIOUS_IMPLEMENTATION=0x...

# Upgrade back to previous version
npx hardhat run scripts/rollback-upgrade.ts --network mainnet
```

### Oracle Failure

If Chainlink feed fails:

```bash
# Switch to fallback price
npx hardhat run scripts/set-fallback-price.ts --network mainnet
```

### Security Incident

1. **Pause contracts immediately**
2. **Notify users via all channels**
3. **Assess damage and vulnerability**
4. **Deploy fix if possible**
5. **Resume operations when safe**
6. **Post-mortem analysis**

## Cost Estimates

### Deployment Costs (Ethereum Mainnet)

Estimated gas costs at 30 gwei:

| Contract | Gas Used | ETH Cost | USD Cost (@$2000/ETH) |
|----------|----------|----------|----------------------|
| Price Oracle | 2,000,000 | 0.06 | $120 |
| Compliance | 3,500,000 | 0.105 | $210 |
| Credit Score | 2,500,000 | 0.075 | $150 |
| Collateral Manager | 3,000,000 | 0.09 | $180 |
| Multi-Asset Collateral | 4,000,000 | 0.12 | $240 |
| Bancafi Lending | 5,000,000 | 0.15 | $300 |
| Debt Collection | 3,000,000 | 0.09 | $180 |
| Private Credit Line | 3,500,000 | 0.105 | $210 |
| Institutional Onboarding | 2,500,000 | 0.075 | $150 |
| Block Market | 4,000,000 | 0.12 | $240 |
| Portfolio Manager | 3,000,000 | 0.09 | $180 |
| Insurance | 3,500,000 | 0.105 | $210 |
| Wallet Integration | 3,000,000 | 0.09 | $180 |
| **Total** | **42,500,000** | **1.275** | **$2,550** |

Add 20-30% for configuration transactions.

### Layer 2 Options

Consider deploying to L2 for lower costs:

- **Arbitrum**: ~10x cheaper
- **Optimism**: ~10x cheaper
- **Polygon**: ~100x cheaper
- **Base**: ~10x cheaper

## Support & Resources

### Documentation
- Smart Contract Docs: `/docs/contracts`
- API Documentation: `/docs/api`
- User Guides: `/docs/guides`

### Community
- Discord: https://discord.gg/bancafi
- Telegram: https://t.me/bancafi
- Twitter: @bancafi

### Development
- GitHub: https://github.com/bancafi/bancafi-credit
- Bug Reports: https://github.com/bancafi/bancafi-credit/issues
- Security: security@bancafi.com

### Audits
- Trail of Bits: [link]
- Quantstamp: [link]
- OpenZeppelin: [link]

## Conclusion

This deployment guide covers the complete process for deploying and maintaining the Bancafi Credit platform. Always test thoroughly on testnet before mainnet deployment, and follow security best practices.

For additional help, contact the development team or join our community channels.
