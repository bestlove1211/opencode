/**
 * Contract Verification Script
 * Verifies all deployed contracts on Etherscan/block explorer
 */

import { run } from 'hardhat';
import { readFileSync } from 'fs';
import { join } from 'path';

async function main() {
  console.log('ðŸ” Starting contract verification...\n');

  // Get network name from hardhat
  const network = await run('network');
  console.log('Network:', network.name);

  // Load deployment addresses
  const deploymentPath = join(__dirname, '../deployments', `${network.name}-latest.json`);

  let addresses: any;
  try {
    addresses = JSON.parse(readFileSync(deploymentPath, 'utf-8'));
  } catch (error) {
    console.error('âŒ Could not load deployment file:', deploymentPath);
    process.exit(1);
  }

  const contracts = [
    {
      name: 'BancafiPriceOracle',
      address: addresses.priceOracle,
      constructorArgs: [],
    },
    {
      name: 'BancafiCompliance',
      address: addresses.compliance,
      constructorArgs: [],
    },
    {
      name: 'CreditScore',
      address: addresses.creditScore,
      constructorArgs: [],
    },
    {
      name: 'CollateralManager',
      address: addresses.collateralManager,
      constructorArgs: [],
    },
    {
      name: 'MultiAssetCollateralManager',
      address: addresses.multiAssetCollateral,
      constructorArgs: [addresses.priceOracle],
    },
    {
      name: 'BancafiLending',
      address: addresses.bancafiLending,
      constructorArgs: [addresses.creditScore, addresses.collateralManager],
    },
    {
      name: 'DebtCollection',
      address: addresses.debtCollection,
      constructorArgs: [addresses.bancafiLending, addresses.creditScore],
    },
    {
      name: 'BancafiPrivateCreditLine',
      address: addresses.privateCreditLine,
      constructorArgs: [addresses.creditScore, addresses.collateralManager],
    },
    {
      name: 'InstitutionalOnboarding',
      address: addresses.institutionalOnboarding,
      constructorArgs: [addresses.compliance],
    },
    {
      name: 'BancafiBlockMarket',
      address: addresses.bancafiBlockMarket,
      constructorArgs: [addresses.debtCollection],
    },
    {
      name: 'BancafiPortfolioManager',
      address: addresses.portfolioManager,
      constructorArgs: [addresses.debtCollection],
    },
    {
      name: 'BancafiInsurance',
      address: addresses.insurance,
      constructorArgs: [addresses.priceOracle],
    },
    {
      name: 'BancafiWalletIntegration',
      address: addresses.walletIntegration,
      constructorArgs: [],
    },
  ];

  let successCount = 0;
  let failCount = 0;

  for (const contract of contracts) {
    if (!contract.address) {
      console.log(`â­ï¸  Skipping ${contract.name} (not deployed)`);
      continue;
    }

    console.log(`\nðŸ“ Verifying ${contract.name} at ${contract.address}...`);

    try {
      await run('verify:verify', {
        address: contract.address,
        constructorArguments: contract.constructorArgs,
      });
      console.log(`âœ… ${contract.name} verified successfully`);
      successCount++;
    } catch (error: any) {
      if (error.message.includes('Already Verified')) {
        console.log(`âœ… ${contract.name} already verified`);
        successCount++;
      } else {
        console.error(`âŒ Failed to verify ${contract.name}:`, error.message);
        failCount++;
      }
    }
  }

  console.log('\n========================================');
  console.log('Verification Summary');
  console.log('========================================');
  console.log(`âœ… Successfully verified: ${successCount}`);
  console.log(`âŒ Failed: ${failCount}`);
  console.log('========================================\n');
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
